<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Substratum - Complete Protocol</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: #0f0; }
        
        /* UI ELEMENTS */
        #radar-locator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 450px; height: 35px; border-bottom: 2px solid #0f0; background: rgba(0,20,0,0.8); text-align: center; line-height: 35px; font-size: 13px; z-index: 100; display: none; }
        #net-monitor { position: absolute; top: 10px; right: 10px; text-align: right; font-size: 11px; z-index: 300; border: 1px solid #0f0; padding: 8px; background: rgba(0,20,0,0.9); }
        
        #main-menu, #blocker { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; background: #000; }
        #blocker { background: rgba(0,0,0,0.8); display: none; }
        .menu-btn { padding: 12px 30px; background: none; border: 1px solid #0f0; color: #0f0; cursor: pointer; margin: 10px; font-family: 'Courier New'; font-size: 16px; width: 250px;}
        .menu-btn:hover { background: #0f0; color: #000; }
        
        #chat-container { position: absolute; bottom: 100px; left: 20px; width: 300px; height: 180px; background: rgba(0,20,0,0.6); border: 1px solid #0f0; display: none; flex-direction: column; z-index: 1000; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 8px; font-size: 12px; }
        #chat-input { background: #000; border: none; border-top: 1px solid #0f0; color: #0f0; padding: 8px; font-family: 'Courier New'; }

        #vitals-hud { position: absolute; bottom: 20px; left: 20px; z-index: 1000; display: none; }
        .bar { width: 200px; height: 12px; border: 1px solid #0f0; background: #000; margin-top: 5px; }
        #hp-fill { height: 100%; background: #f00; width: 100%; }
        #stamina-fill { height: 100%; background: #0f0; width: 100%; }
        #data-hud { position: absolute; bottom: 20px; right: 20px; text-align: right; z-index: 1000; display: none; border: 1px solid #0f0; padding: 10px; background: rgba(0,20,0,0.5); }
    </style>
</head>
<body>

    <div id="radar-locator">EXIT: <span id="door-dist">--</span>m | <span id="secondary-scanner">SCANNING...</span></div>
    <div id="net-monitor">NETWORK: <span id="net-state">CONNECTING...</span><br>PARTY: <span id="party-state">OFFLINE</span></div>

    <div id="main-menu">
        <h1 style="letter-spacing:10px;">SUBSTRATUM</h1>
        <div id="initial-actions" style="display:flex; flex-direction:column;">
            <button onclick="startGame(false)" class="menu-btn">SOLO RUN</button>
            <button onclick="showPartyMenu()" class="menu-btn">PARTY MODE</button>
        </div>
        <div id="party-options" style="display:none; flex-direction:column; align-items:center;">
            <input type="text" id="join-code" placeholder="ENTER ROOM CODE" style="background:#000; color:#0f0; border:1px solid #0f0; text-align:center; padding:12px; margin:10px; width: 220px; font-family:'Courier New';">
            <button onclick="startGame(true, true)" class="menu-btn">JOIN SESSION</button>
            <button onclick="startGame(true, false)" class="menu-btn">HOST SESSION</button>
            <button onclick="hidePartyMenu()" style="color:#555; background:none; border:none; cursor:pointer; margin-top:10px;">[ BACK ]</button>
        </div>
    </div>

    <div id="blocker"><h1>SYSTEM READY</h1><p>CLICK TO SYNC</p></div>

    <div id="chat-container">
        <div id="chat-log">SYSTEM: Neural Link Active. [ENTER] to chat.</div>
        <input type="text" id="chat-input" placeholder="...">
    </div>

    <div id="vitals-hud">
        HP <div class="bar"><div id="hp-fill"></div></div>
        SP <div class="bar"><div id="stamina-fill"></div></div>
    </div>

    <div id="data-hud">
        FLOOR: <span id="floor-num">1</span><br>
        ARTIFACTS: <span id="art-count">0</span> / 5
    </div>

    <script>
        let scene, camera, renderer, controls, socket, flashlight, flashTarget;
        let moveF = false, moveB = false, moveL = false, moveR = false, isSprint = false;
        let velocity = new THREE.Vector3(), direction = new THREE.Vector3();
        let hp = 100, stamina = 100, artifacts = 0, currentFloor = 1;
        let walls = [], collectibles = [], exitPortal, currentRoom = null;
        let prevTime = performance.now();

        // POINTING TO THE LIVE RENDER SERVER
        socket = io('https://substratum-game.onrender.com', { transports: ['websocket'] });

        socket.on('connect', () => { 
            document.getElementById('net-state').innerText = "CONNECTED"; 
            document.getElementById('net-state').style.color = "#0f0";
        });

        socket.on('connect_error', () => {
            document.getElementById('net-state').innerText = "LINK FAILURE";
            document.getElementById('net-state').style.color = "#f00";
        });

        socket.on('chat-msg', (data) => {
            const log = document.getElementById('chat-log');
            log.innerHTML += `<div>[${data.user}]: ${data.msg}</div>`;
            log.scrollTop = log.scrollHeight;
        });

        function showPartyMenu() { 
            document.getElementById('initial-actions').style.display = 'none'; 
            document.getElementById('party-options').style.display = 'flex'; 
        }
        function hidePartyMenu() { 
            document.getElementById('initial-actions').style.display = 'flex'; 
            document.getElementById('party-options').style.display = 'none'; 
        }

        function startGame(isParty, isJoining) {
            if(isParty) {
                currentRoom = isJoining ? document.getElementById('join-code').value.toUpperCase() : Math.random().toString(36).substring(7).toUpperCase();
                if(currentRoom) {
                    socket.emit('join-room', currentRoom);
                    document.getElementById('party-state').innerText = "ROOM: " + currentRoom;
                    if(!isJoining) alert("YOUR ROOM CODE: " + currentRoom);
                }
            }
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('blocker').style.display = 'flex';
            init();
        }

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.08);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

            // SUPER BRIGHT FLASHLIGHT
            flashlight = new THREE.SpotLight(0xffffff, 40, 180, Math.PI/4, 0.3, 1);
            flashTarget = new THREE.Object3D();
            scene.add(flashTarget);
            flashlight.target = flashTarget;
            scene.add(flashlight);
            scene.add(new THREE.AmbientLight(0x0a0a0a));

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            controls = new THREE.PointerLockControls(camera, document.body);
            document.getElementById('blocker').addEventListener('click', () => controls.lock());
            
            controls.addEventListener('lock', () => {
                document.getElementById('blocker').style.display = 'none';
                ["vitals-hud", "data-hud", "chat-container", "radar-locator"].forEach(id => document.getElementById(id).style.display = 'flex');
            });

            generateFloor();
            animate();
        }

        function generateFloor() {
            walls.forEach(w => scene.remove(w));
            collectibles.forEach(c => scene.remove(c));
            if(exitPortal) scene.remove(exitPortal);
            walls = []; collectibles = []; artifacts = 0;

            const GRID = 14; const SIZE = 12;
            let mazeData = Array(GRID).fill().map(() => Array(GRID).fill(1));
            for(let y=1; y<GRID-1; y+=2) for(let x=1; x<GRID-1; x+=2) {
                mazeData[y][x] = 0;
                if(Math.random() > 0.45 && x < GRID-2) mazeData[y][x+1] = 0; else if(y < GRID-2) mazeData[y+1][x] = 0;
            }

            const wallGeo = new THREE.BoxGeometry(SIZE, 18, SIZE);
            const wallMat = new THREE.MeshStandardMaterial({color: 0x111111});
            for(let y=0; y<GRID; y++) for(let x=0; x<GRID; x++) {
                if(mazeData[y][x] === 1) {
                    const w = new THREE.Mesh(wallGeo, wallMat);
                    w.position.set(x*SIZE, 9, y*SIZE);
                    w.userData.box = new THREE.Box3().setFromObject(w);
                    scene.add(w); walls.push(w);
                }
            }

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x050505}));
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);
            camera.position.set(SIZE, 1.6, SIZE);

            exitPortal = new THREE.Mesh(new THREE.BoxGeometry(6,12,6), new THREE.MeshBasicMaterial({color: 0x00ff00, wireframe: true}));
            exitPortal.position.set((GRID-2)*SIZE, 6, (GRID-2)*SIZE);
            scene.add(exitPortal);

            for(let i=0; i<5; i++) {
                const a = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color: 0x00ffff}));
                a.position.set(Math.random()*GRID*SIZE, 1, Math.random()*GRID*SIZE);
                scene.add(a); collectibles.push(a);
            }
        }

        function isColliding(pos) {
            // Player hitbox 3.5x3.5
            const playerBox = new THREE.Box3().setFromCenterAndSize(pos, new THREE.Vector3(3.5, 4, 3.5));
            for(let wall of walls) {
                if(playerBox.intersectsBox(wall.userData.box)) return true;
            }
            return false;
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if(controls.isLocked) {
                flashlight.position.copy(camera.position);
                const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                flashTarget.position.copy(camera.position).add(dir);

                let speed = (isSprint && stamina > 0) ? 95 : 50;
                if(isSprint && (moveF || moveB || moveL || moveR)) stamina = Math.max(0, stamina - 35 * delta);
                else stamina = Math.min(100, stamina + 20 * delta);

                velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveF) - Number(moveB); direction.x = Number(moveR) - Number(moveL);
                direction.normalize();
                if (moveF || moveB) velocity.z -= direction.z * speed * 5 * delta;
                if (moveL || moveR) velocity.x -= direction.x * speed * 5 * delta;

                // FLUID SLIDING COLLISION
                const nextX = camera.position.clone();
                const rightVec = new THREE.Vector3().setFromMatrixColumn(camera.matrix, 0);
                nextX.add(rightVec.multiplyScalar(velocity.x * delta));
                if (!isColliding(nextX)) controls.moveRight(-velocity.x * delta);
                else velocity.x = 0;

                const nextZ = camera.position.clone();
                const forwardVec = new THREE.Vector3().setFromMatrixColumn(camera.matrix, 2);
                nextZ.add(forwardVec.multiplyScalar(velocity.z * delta));
                if (!isColliding(nextZ)) controls.moveForward(-velocity.z * delta);
                else velocity.z = 0;

                document.getElementById('door-dist').innerText = Math.floor(camera.position.distanceTo(exitPortal.position));
                if(camera.position.distanceTo(exitPortal.position) < 5 && artifacts >= 5) { 
                    currentFloor++; generateFloor(); 
                    document.getElementById('floor-num').innerText = currentFloor;
                }
            }

            document.getElementById('hp-fill').style.width = hp + '%';
            document.getElementById('stamina-fill').style.width = stamina + '%';
            document.getElementById('art-count').innerText = artifacts;
            renderer.render(scene, camera);
            prevTime = time;
        }

        window.addEventListener('keydown', (e) => {
            if(e.code === 'Enter') {
                const input = document.getElementById('chat-input');
                if(document.activeElement === input) {
                    if(input.value) {
                        socket.emit('chat-msg', {room: currentRoom, msg: input.value, user: "DIVER"});
                    }
                    input.value = ""; input.blur(); controls.lock();
                } else { controls.unlock(); input.focus(); }
            }
            if(e.code==='KeyW') moveF=true; if(e.code==='KeyS') moveB=true;
            if(e.code==='KeyA') moveL=true; if(e.code==='KeyD') moveR=true;
            if(e.shiftKey) isSprint=true;
            if(e.code==='KeyE') {
                collectibles.forEach((c, i) => { if(camera.position.distanceTo(c.position) < 6) { artifacts++; scene.remove(c); collectibles.splice(i,1); } });
            }
        });
        window.addEventListener('keyup', (e) => {
            if(e.code==='KeyW') moveF=false; if(e.code==='KeyS') moveB=false;
            if(e.code==='KeyA') moveL=false; if(e.code==='KeyD') moveR=false;
            if(!e.shiftKey) isSprint=false;
        });
    </script>
</body>
</html>
